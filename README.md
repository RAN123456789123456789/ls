# 图书借阅小程序 v1.0

## 📚 项目简介

这是一个基于微信小程序的图书借阅管理系统，支持用户借阅申请、管理员审核、订阅消息提醒等功能。

## ✨ 核心功能

### 用户功能
- ✅ 微信一键登录（头像昵称填写能力）
- ✅ 图书浏览和搜索
- ✅ 借阅申请（支持借出/复印/参考三种类型）
- ✅ 我的借阅记录查看
- ✅ 申请归还图书
- ✅ 个人资料编辑（头像、昵称、手机号、部门、邮箱）
- ✅ 自动填充已保存的信息（手机号、部门、邮箱）

### 管理员功能
- ✅ 管理员登录
- ✅ 借阅申请审核（通过/拒绝）
- ✅ 确认借出（填写档号和借出理由）
- ✅ 确认归还
- ✅ 借阅类型筛选（已归还标签页：全部/借出/复印/参考）
- ✅ 借阅类型标签显示（借出-绿色、复印-蓝色、参考-黄色）
- ✅ 查看申请详情（包括备注信息）

### 订阅消息
- ✅ 借阅成功通知
- ✅ 归还提醒通知（归还日期前1天、3天、7天）
- ✅ 逾期提醒通知
- ✅ 归还成功通知

## 🚀 快速开始

### 环境要求
- 微信开发者工具
- Node.js（用于后端服务）
- 微信小程序账号

### 安装步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/RAN123456789123456789/ls.git
   cd miniprogram-2
   ```

2. **配置小程序**
   - 使用微信开发者工具打开项目
   - 在 `project.config.json` 中配置你的 AppID

3. **配置后端服务**
   - 参考"后端部署"章节配置云托管服务
   - 配置环境变量：`WX_APPID` 和 `WX_SECRET`

4. **配置域名**
   - 在微信公众平台配置服务器域名
   - 参考"域名配置"章节

## 📋 配置指南

### 域名配置

#### 测试环境（立即可用）
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** → **开发管理** → **开发设置**
3. 在 **request合法域名** 中添加：
   ```
   https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com
   ```
4. 点击 **保存**

⚠️ **注意**：云托管默认域名仅用于测试，正式环境必须使用自定义域名。

#### 正式环境（必须配置）
1. 在微信云托管添加自定义域名（如 `api.ranguofang.com`）
2. 配置DNS解析（CNAME记录）
3. 在微信公众平台添加自定义域名
4. 更新代码中的API地址（以下文件）：
   - `miniprogram/utils/borrowRequestService.ts`
   - `miniprogram/utils/borrowService.ts`
   - `miniprogram/utils/subscribeService.ts`
   - `miniprogram/utils/userService.ts`
5. 域名备案（如果使用主域名）

### 后端部署

#### 使用微信云托管（推荐）

1. **配置环境变量**
   - `WX_APPID` - 小程序 AppID
   - `WX_SECRET` - 小程序 Secret

2. **配置代码仓库**
   - 在云托管控制台配置GitHub仓库
   - 仓库地址：`https://github.com/RAN123456789123456789/ls`
   - 分支：`main`

3. **部署服务**
   - 点击"发布"按钮
   - 等待构建和部署完成

#### 后端接口说明

**健康检查**
- `GET /health` - 服务健康检查

**订阅消息发送**
- `POST /api/subscribe/send` - 发送订阅消息
  - 请求体：
    ```json
    {
      "openId": "用户openId",
      "templateId": "模板ID",
      "page": "页面路径（可选）",
      "data": {
        "thing1": { "value": "图书名称" },
        "date2": { "value": "2024-01-01" }
      }
    }
    ```

### 管理员设置

#### 方法一：通过代码配置（推荐）

编辑 `miniprogram/utils/adminService.ts` 文件，在 `ADMIN_OPENIDS` 数组中添加管理员的 openId：

```typescript
const ADMIN_OPENIDS: string[] = [
    'admin_openid_1',  // 添加管理员的openId
    'admin_openid_2',  // 可以添加多个管理员
];
```

**如何获取 openId：**
1. 在小程序中登录
2. 打开开发者工具的控制台
3. 查看日志中的 openId
4. 或者调用 `wx.getStorageSync('user_openId')` 获取

### 订阅消息配置

1. **申请订阅消息模板**
   - 登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 进入 **功能** → **订阅消息**
   - 申请以下模板：
     - 借阅成功通知
     - 归还提醒通知
     - 逾期提醒通知
     - 归还成功通知

2. **配置模板ID**
   - 将获取到的模板ID替换到 `miniprogram/utils/subscribeMessage.ts` 中的 `SUBSCRIBE_MESSAGE_TEMPLATES`

## 📱 测试指南

### 真机调试（开发时使用）

1. 打开微信开发者工具
2. 点击"真机调试"按钮
3. 用手机微信扫描二维码
4. 开始调试

### 体验版测试

1. **上传代码**
   - 在微信开发者工具中点击"上传"
   - 填写版本号和备注

2. **设置为体验版**
   - 登录微信公众平台
   - 进入 **开发** → **版本管理**
   - 找到上传的版本，点击"选为体验版"

3. **添加体验者**
   - 进入 **设置** → **成员管理** → **体验者**
   - 添加体验者微信号

4. **在手机搜索小程序**
   - 搜索小程序名称或AppID
   - 进入小程序测试

## 🔧 常见问题

### 1. 小程序无法访问API？
- 检查是否在微信公众平台配置了服务器域名
- 确认域名配置正确（只填写域名，不包含路径）
- 确保使用 `https://` 协议

### 2. 获取头像失败？
- 已修复：使用新的头像昵称填写能力（`open-type="chooseAvatar"`）
- 不再使用已废弃的 `wx.getUserProfile` API

### 3. 域名配置问题？
- 检查DNS配置是否正确（使用CNAME记录）
- 确认域名已绑定到云托管服务
- 测试环境可以使用云托管默认域名

### 4. 手机号授权失败？
- 个人开发者小程序无法使用手机号授权
- 需要升级为企业/组织类小程序
- 或使用手动输入手机号功能

### 5. 数据库查询慢？
- 在云开发控制台为 `user` 集合创建索引
- 建议创建组合索引：`openId` + `_openid`

## 📝 重要说明

### 关于服务器
- ✅ **不需要购买服务器**：使用微信云托管，无需自己购买服务器
- ✅ **不需要服务器备案**：云托管已处理服务器备案
- ✅ **自动SSL证书**：云托管自动配置HTTPS证书

### 关于域名
- ⚠️ **测试环境**：可以使用云托管默认域名
- ⚠️ **正式环境**：必须使用自定义域名
- ⚠️ **域名备案**：如果使用主域名，可能需要ICP备案

### 关于数据
- ✅ 使用云开发数据库存储用户和借阅数据
- ✅ 用户唯一性通过 `openId` 和 `_openid` 保证
- ✅ 支持数据同步和备份

## 🎯 技术栈

- **前端**：微信小程序（TypeScript）
- **后端**：Node.js + Express
- **数据库**：微信云开发数据库
- **部署**：微信云托管

## 📄 项目结构

```
miniprogram-2/
├── miniprogram/          # 小程序前端代码
│   ├── pages/           # 页面
│   │   ├── admin/       # 管理员中心
│   │   ├── adminReview/ # 借阅审核
│   │   ├── books/       # 图书列表
│   │   ├── borrowForm/  # 借阅表单
│   │   ├── mine/        # 个人中心
│   │   └── ...
│   ├── utils/           # 工具函数
│   │   ├── adminService.ts
│   │   ├── borrowRequestService.ts
│   │   ├── userService.ts
│   │   └── ...
│   └── components/      # 组件
├── server.js            # 后端服务
├── Dockerfile           # Docker配置
├── package.json         # 依赖配置
└── README.md           # 项目文档
```

## 🔄 版本历史

### v1.0.0 (2024-01-XX)
- ✅ 初始版本发布
- ✅ 完整的借阅功能
- ✅ 管理员审核功能
- ✅ 订阅消息系统
- ✅ 借阅类型筛选和显示
- ✅ 自动填充用户信息

## 📞 技术支持

如遇到问题，请：
1. 查看本文档的"常见问题"章节
2. 检查微信开发者工具的控制台日志
3. 查看云托管服务的运行日志

## 📜 许可证

本项目采用 MIT 许可证。

---

**注意**：本项目使用微信云托管作为后端服务，无需购买服务器。正式环境需要配置自定义域名。
