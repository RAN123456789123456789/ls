<!--pages/adminReview/adminReview.wxml-->
<view class="container">
  <!-- 标签页切换 -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === 'pending' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="pending"
    >
      <text>待审核</text>
    </view>
    <view 
      class="tab-item {{currentTab === 'approved' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="approved"
    >
      <text>已批准</text>
    </view>
    <view 
      class="tab-item {{currentTab === 'borrowed' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="borrowed"
    >
      <text>已借出</text>
    </view>
    <view 
      class="tab-item {{currentTab === 'returned' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="returned"
    >
      <text>已归还</text>
    </view>
  </view>

  <!-- 筛选器（仅在已归还标签页显示） -->
  <view class="filter-bar" wx:if="{{currentTab === 'returned'}}">
    <view 
      class="filter-item {{borrowTypeFilter === '' ? 'active' : ''}}"
      bindtap="onFilterChange"
      data-type=""
    >
      <text>全部</text>
    </view>
    <view 
      class="filter-item {{borrowTypeFilter === 'borrow' ? 'active' : ''}}"
      bindtap="onFilterChange"
      data-type="borrow"
    >
      <text>借出</text>
    </view>
    <view 
      class="filter-item {{borrowTypeFilter === 'copy' ? 'active' : ''}}"
      bindtap="onFilterChange"
      data-type="copy"
    >
      <text>复印</text>
    </view>
    <view 
      class="filter-item {{borrowTypeFilter === 'reference' ? 'active' : ''}}"
      bindtap="onFilterChange"
      data-type="reference"
    >
      <text>参考</text>
    </view>
  </view>

  <!-- 申请列表 -->
  <scroll-view 
    class="request-list" 
    scroll-y
    refresher-enabled
    refresher-triggered="{{loading}}"
    bindrefresherrefresh="onPullDownRefresh"
  >
    <view wx:if="{{loading && requests.length === 0}}" class="loading">
      <text>加载中...</text>
    </view>

    <view wx:elif="{{filteredRequests.length === 0}}" class="empty">
      <text>暂无申请记录</text>
    </view>

    <view 
      class="request-item" 
      wx:for="{{filteredRequests}}" 
      wx:key="id"
    >
      <view class="request-header">
        <text class="book-name">{{item.bookName || '未命名档案'}}</text>
        <view class="header-right">
          <text class="borrow-type-badge {{item.borrowTypeClass}}">
            {{item.borrowTypeText}}
          </text>
          <text class="status-badge {{getStatusClass(item.status)}}">
            {{getStatusText(item.status)}}
          </text>
        </view>
      </view>

      <view class="request-info">
        <!-- 必填字段：姓名 -->
        <view class="info-row">
          <text class="info-label">借阅人：</text>
          <text class="info-value">{{item.name || '未填写'}}</text>
        </view>
        <!-- 必填字段：电话 -->
        <view class="info-row">
          <text class="info-label">电话：</text>
          <text class="info-value">{{item.phone || '未填写'}}</text>
        </view>
        <!-- 必填字段：借阅日期 -->
        <view class="info-row">
          <text class="info-label">借阅日期：</text>
          <text class="info-value">{{item.borrowDate || '未选择'}}</text>
        </view>
        <!-- 必填字段：归还日期 -->
        <view class="info-row">
          <text class="info-label">归还日期：</text>
          <text class="info-value">{{item.returnDate || '未选择'}}</text>
        </view>
        <!-- 必填字段：借阅天数 -->
        <view class="info-row">
          <text class="info-label">借阅天数：</text>
          <text class="info-value">{{item.borrowDays || 0}}天</text>
        </view>
        <!-- 可选字段：借阅事由 -->
        <view class="info-row" wx:if="{{item.reason}}">
          <text class="info-label">借阅事由：</text>
          <text class="info-value">{{item.reason}}</text>
        </view>
        <!-- 申请时间 -->
        <view class="info-row">
          <text class="info-label">申请时间：</text>
          <text class="info-value">{{item.formattedCreatedAt || item.createdAt}}</text>
        </view>
      </view>

      <!-- 待审核状态：显示通过/拒绝按钮 -->
      <view class="request-actions" wx:if="{{item.status === 'pending'}}">
        <button
          class="action-btn approve-btn"
          bindtap="onReview"
          data-requestid="{{item.id}}"
          data-action="approve"
        >
          通过
        </button>
        <button 
          class="action-btn reject-btn"
          bindtap="onReview"
          data-requestid="{{item.id}}"
          data-action="reject"
        >
          拒绝
        </button>
        <button 
          class="action-btn detail-btn"
          bindtap="onViewDetail"
          data-requestid="{{item.id}}"
        >
          详情
        </button>
      </view>

      <!-- 已批准状态：显示确认借出按钮（参考类型不显示此按钮，因为参考类型跳过此步骤） -->
      <view class="request-actions" wx:elif="{{item.status === 'approved'}}">
        <button 
          class="action-btn borrow-btn"
          bindtap="confirmBorrowRecord"
          data-id="{{item.id}}"
        >
          确认借出
        </button>
        <button 
          class="action-btn detail-btn"
          bindtap="onViewDetail"
          data-requestid="{{item.id}}"
        >
          详情
        </button>
      </view>

      <!-- 已借出状态：显示确认归还按钮 -->
      <view class="request-actions" wx:elif="{{item.status === 'borrowed'}}">
        <button 
          class="action-btn return-btn"
          bindtap="confirmReturnRecord"
          data-id="{{item.id}}"
        >
          确认归还
        </button>
        <button 
          class="action-btn detail-btn"
          bindtap="onViewDetail"
          data-requestid="{{item.id}}"
        >
          详情
        </button>
      </view>

      <!-- 已归还或其他状态：只显示详情按钮 -->
      <view class="request-actions" wx:else>
        <button 
          class="action-btn detail-btn"
          bindtap="onViewDetail"
          data-requestid="{{item.id}}"
        >
          查看详情
        </button>
      </view>
    </view>
  </scroll-view>

  <!-- 确认借出弹窗 -->
  <view class="modal" wx:if="{{showBorrowModal}}" bindtap="closeBorrowModal">
    <view class="modal-content borrow-modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">确认借出</text>
        <text class="modal-close" bindtap="closeBorrowModal">✕</text>
      </view>
      <view class="modal-body">
        <!-- 档号输入区域 -->
        <view class="form-section">
          <text class="form-label">档号 <text class="required-mark">*</text></text>
          <view class="archive-input-list">
            <view class="archive-input-item" wx:for="{{archiveNumbers}}" wx:key="index">
              <input 
                class="archive-input" 
                type="text" 
                placeholder="请输入档号" 
                value="{{item}}"
                data-index="{{index}}"
                bindinput="onArchiveNumberInput"
                maxlength="100"
              />
              <text class="remove-btn" bindtap="removeArchiveNumber" data-index="{{index}}">删除</text>
            </view>
            <button class="add-archive-btn" bindtap="addArchiveNumber">+ 添加档号</button>
          </view>
        </view>

        <!-- 理由输入区域 -->
        <view class="form-section">
          <text class="form-label">借出理由 <text class="required-mark">*</text></text>
          <textarea 
            class="reason-textarea" 
            placeholder="请输入借出理由" 
            value="{{borrowReason}}"
            bindinput="onBorrowReasonInput"
            maxlength="500"
            auto-height
          ></textarea>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="closeBorrowModal">取消借出</button>
        <button class="modal-btn confirm-btn" bindtap="confirmBorrowWithInfo">确定借出</button>
      </view>
    </view>
  </view>
</view>

