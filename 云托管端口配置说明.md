# 云托管端口配置说明

## 🔍 问题原因

端口 80 需要 root 权限，但 Node.js 容器默认以非 root 用户运行，导致无法绑定端口。

## ✅ 解决方案

使用非特权端口 8080，然后在云托管配置端口映射。

## 📋 云托管配置步骤

### 1. 配置端口映射

在微信云托管控制台：

1. **进入服务设置**
   - 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
   - 进入 **微信云托管** → 你的环境（express-bec5）
   - 点击服务名称进入服务详情

2. **配置端口**
   - 进入 **服务设置** → **端口配置**
   - **容器端口**：`8080`
   - **访问端口**：`80`（或保持默认）
   - **协议**：HTTP

3. **配置健康检查**
   - 进入 **服务设置** → **健康检查**
   - **健康检查路径**：`/health`
   - **健康检查端口**：`8080`（重要！使用容器端口）
   - **超时时间**：30 秒
   - **检查间隔**：10 秒

### 2. 配置环境变量

确保已配置：
- `WX_APPID` = `wxc514634bfc130f84`
- `WX_SECRET` = 你的小程序 Secret

### 3. 重新部署

1. 点击 **"发布"** 按钮
2. 选择代码仓库部署
3. 等待构建完成

## 📝 当前配置

- **容器端口**：8080（服务实际监听的端口）
- **访问端口**：80（外部访问端口，云托管自动映射）
- **健康检查路径**：`/health`
- **健康检查端口**：8080（必须使用容器端口）

## ⚠️ 重要提示

**健康检查端口必须使用容器端口（8080），不是访问端口（80）！**

因为健康检查是在容器内部进行的，所以需要使用容器实际监听的端口。

## 🔧 如果还有问题

### 检查1：查看运行日志

部署后查看"运行日志"，确认：
- 服务是否正常启动
- 是否显示：`服务器运行在端口 8080`
- 是否有错误信息

### 检查2：验证健康检查

健康检查接口：
- **路径**：`GET /health`
- **容器内访问**：`http://localhost:8080/health`
- **响应**：`{ "status": "ok", "message": "服务运行正常" }`

### 检查3：端口配置

确认：
- 容器端口：8080 ✅
- 访问端口：80（或根据需要）✅
- 健康检查端口：8080 ✅（关键！）

## 📊 端口映射原理

```
外部访问（80端口）
    ↓
云托管端口映射
    ↓
容器内部（8080端口）
    ↓
Express服务监听8080
```

## ✅ 验证部署成功

部署成功后应该看到：
1. ✅ 服务状态：运行中
2. ✅ 实例数量：≥ 1
3. ✅ 健康检查：通过
4. ✅ 运行日志：`服务器运行在端口 8080`

## 🎯 下一步

1. ✅ 代码已更新（使用8080端口）
2. ⚠️ 在云托管配置端口映射（容器8080 → 访问80）
3. ⚠️ 配置健康检查（端口8080，路径/health）
4. ⚠️ 重新部署服务

