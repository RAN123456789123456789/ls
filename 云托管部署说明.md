# 云托管部署说明

## ✅ 已创建的文件

1. **Dockerfile** - Docker 构建文件
2. **server.js** - Express 后端服务器
3. **.dockerignore** - Docker 构建忽略文件
4. **package.json** - 已更新，包含后端依赖

## 📋 部署步骤

### 1. 配置环境变量

在微信云托管控制台配置以下环境变量：

**必需的环境变量**：
- `WX_APPID` - 你的小程序 AppID（如：wxc514634bfc130f84）
- `WX_SECRET` - 你的小程序 Secret

**可选的环境变量**：
- `PORT` - 服务端口（默认：8080）

**配置方法**：
1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 **微信云托管** → 你的环境（express-bec5）
3. 进入 **服务设置** → **环境变量**
4. 添加环境变量：
   - 变量名：`WX_APPID`，变量值：你的 AppID
   - 变量名：`WX_SECRET`，变量值：你的 Secret

### 2. 配置代码仓库

**如果使用 GitHub 仓库部署**：

1. **确保仓库是公开的**（或配置访问权限）
   - 如果仓库是私有的，需要在云托管配置 GitHub Token
   - 或者将仓库设置为公开

2. **在云托管配置代码仓库**：
   - 仓库地址：`https://github.com/RAN123456789123456789/ls`
   - 分支：`main`
   - 构建目录：`/`（根目录）

### 3. 重新部署

1. 在云托管控制台点击 **"发布"** 按钮
2. 选择代码仓库部署方式
3. 等待构建和部署完成

## ⚠️ 关于 GitHub 404 错误

如果遇到 GitHub API 404 错误，可能的原因：

### 原因1：仓库是私有的
**解决**：
- 将仓库设置为公开（Settings → Change visibility → Make public）
- 或者在云托管配置 GitHub Personal Access Token

### 原因2：仓库不存在或地址错误
**解决**：
- 确认仓库地址正确：`https://github.com/RAN123456789123456789/ls`
- 确认仓库已存在且可以访问

### 原因3：需要配置 GitHub Token
**解决**：
1. 在 GitHub 创建 Personal Access Token
   - Settings → Developer settings → Personal access tokens → Tokens (classic)
   - 生成新 token，权限选择 `repo`
2. 在云托管配置 Token
   - 服务设置 → 代码仓库 → 配置访问凭证

## 🔧 本地测试（可选）

如果想在本地测试后端服务：

```bash
# 安装依赖
npm install

# 设置环境变量（Windows PowerShell）
$env:WX_APPID="你的AppID"
$env:WX_SECRET="你的Secret"

# 启动服务
npm start

# 或直接运行
node server.js
```

测试健康检查：
```bash
curl http://localhost:8080/health
```

## 📝 后端接口说明

### 健康检查
- **路径**：`GET /health`
- **响应**：`{ "status": "ok", "message": "服务运行正常" }`

### 订阅消息发送
- **路径**：`POST /api/subscribe/send`
- **请求体**：
  ```json
  {
    "openId": "用户openId",
    "templateId": "模板ID",
    "page": "页面路径（可选）",
    "data": {
      "thing1": { "value": "图书名称" },
      "date2": { "value": "2024-01-01" }
    }
  }
  ```
- **响应**：
  ```json
  {
    "success": true,
    "message": "发送成功"
  }
  ```

## 🎯 下一步

1. ✅ 配置环境变量（WX_APPID 和 WX_SECRET）
2. ✅ 确认 GitHub 仓库可以访问（公开或配置 Token）
3. ✅ 在云托管重新部署
4. ✅ 测试 API 接口是否正常工作

## 💡 提示

- **安全**：不要将 Secret 硬编码在代码中，使用环境变量
- **日志**：部署后可以在"运行日志"中查看服务日志
- **监控**：可以在"服务监控"中查看服务状态和性能指标

