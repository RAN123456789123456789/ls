# å€Ÿé˜…åŠŸèƒ½é…ç½®è¯´æ˜

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
- âœ… è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼ˆæˆæƒã€å‘é€ã€å®šæ—¶æé†’ï¼‰
- âœ… ç”¨æˆ·æœåŠ¡ï¼ˆè·å–openIdï¼‰
- âœ… å€Ÿé˜…æœåŠ¡ï¼ˆå›¾ä¹¦åˆ—è¡¨ã€è¯¦æƒ…ã€å€Ÿé˜…ã€å½’è¿˜ï¼‰
- âœ… å€Ÿé˜…è®°å½•ç®¡ç†

### 2. é¡µé¢åŠŸèƒ½
- âœ… é¦–é¡µï¼ˆåŠŸèƒ½å…¥å£ï¼‰
- âœ… å›¾ä¹¦åˆ—è¡¨é¡µé¢ï¼ˆæœç´¢ã€æµè§ˆï¼‰
- âœ… å›¾ä¹¦è¯¦æƒ…é¡µé¢ï¼ˆæŸ¥çœ‹è¯¦æƒ…ã€å€Ÿé˜…æ“ä½œï¼‰
- âœ… æˆ‘çš„å€Ÿé˜…é¡µé¢ï¼ˆæŸ¥çœ‹è®°å½•ã€å½’è¿˜æ“ä½œï¼‰
- âœ… è®¢é˜…ç®¡ç†é¡µé¢ï¼ˆæˆæƒç®¡ç†ï¼‰

## âš ï¸ éœ€è¦é…ç½®æ‰èƒ½ä½¿ç”¨çš„éƒ¨åˆ†

### 1. è®¢é˜…æ¶ˆæ¯æ¨¡æ¿é…ç½®ï¼ˆå¿…éœ€ï¼‰

**ä½ç½®**ï¼š`miniprogram/utils/subscribeMessage.ts`

éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ï¼Œå¹¶å°†æ¨¡æ¿IDæ›¿æ¢åˆ°ä»£ç ä¸­ï¼š

```typescript
export const SUBSCRIBE_MESSAGE_TEMPLATES = {
  [SubscribeMessageType.BORROW_SUCCESS]: {
    templateId: 'YOUR_BORROW_SUCCESS_TEMPLATE_ID', // âš ï¸ éœ€è¦æ›¿æ¢
    // ...
  },
  // å…¶ä»–æ¨¡æ¿ä¹Ÿéœ€è¦æ›¿æ¢
}
```

**é…ç½®æ­¥éª¤**ï¼š
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥ **åŠŸèƒ½ -> è®¢é˜…æ¶ˆæ¯**
3. ç”³è¯·4ä¸ªè®¢é˜…æ¶ˆæ¯æ¨¡æ¿ï¼š
   - å€Ÿé˜…æˆåŠŸé€šçŸ¥
   - å½’è¿˜æé†’é€šçŸ¥
   - é€¾æœŸæé†’é€šçŸ¥
   - å½’è¿˜æˆåŠŸé€šçŸ¥
4. å°†æ¨¡æ¿IDå¤åˆ¶åˆ°ä»£ç ä¸­æ›¿æ¢

### 2. åç«¯APIé…ç½®ï¼ˆå¿…éœ€ï¼‰

#### 2.1 ç”¨æˆ·æœåŠ¡API

**ä½ç½®**ï¼š`miniprogram/utils/userService.ts`

```typescript
const API_BASE_URL = 'https://your-api-domain.com/api'; // âš ï¸ éœ€è¦æ›¿æ¢
```

**éœ€è¦å®ç°çš„åç«¯æ¥å£**ï¼š
- `POST /api/user/getOpenId` - è·å–ç”¨æˆ·openId
  - è¯·æ±‚å‚æ•°ï¼š`{ code: string }`
  - å“åº”ï¼š`{ success: boolean, data: { openId: string } }`

#### 2.2 å€Ÿé˜…æœåŠ¡API

**ä½ç½®**ï¼š`miniprogram/utils/borrowService.ts`

```typescript
const API_BASE_URL = 'https://your-api-domain.com/api'; // âš ï¸ éœ€è¦æ›¿æ¢
```

**éœ€è¦å®ç°çš„åç«¯æ¥å£**ï¼š
- `GET /api/book/list` - è·å–å›¾ä¹¦åˆ—è¡¨
  - è¯·æ±‚å‚æ•°ï¼š`{ keyword?: string, category?: string, page?: number, pageSize?: number }`
  - å“åº”ï¼š`{ success: boolean, data: BookInfo[] }`

- `GET /api/book/detail` - è·å–å›¾ä¹¦è¯¦æƒ…
  - è¯·æ±‚å‚æ•°ï¼š`{ bookId: string }`
  - å“åº”ï¼š`{ success: boolean, data: BookInfo }`

- `POST /api/borrow/create` - åˆ›å»ºå€Ÿé˜…è®°å½•
  - è¯·æ±‚å‚æ•°ï¼š`{ openId: string, bookId: string, bookName: string, borrowDate: string, returnDate: string }`
  - å“åº”ï¼š`{ success: boolean, data: { recordId: string, borrowNumber: string } }`

- `POST /api/borrow/return` - å½’è¿˜å›¾ä¹¦
  - è¯·æ±‚å‚æ•°ï¼š`{ openId: string, recordId: string }`
  - å“åº”ï¼š`{ success: boolean, message?: string }`

- `GET /api/borrow/myRecords` - è·å–æˆ‘çš„å€Ÿé˜…è®°å½•
  - è¯·æ±‚å‚æ•°ï¼š`{ openId: string }`
  - å“åº”ï¼š`{ success: boolean, data: BorrowRecord[] }`

#### 2.3 è®¢é˜…æ¶ˆæ¯å‘é€API

**ä½ç½®**ï¼š`miniprogram/utils/subscribeService.ts`

```typescript
const API_BASE_URL = 'https://your-api-domain.com/api'; // âš ï¸ éœ€è¦æ›¿æ¢
```

**éœ€è¦å®ç°çš„åç«¯æ¥å£**ï¼š
- `POST /api/subscribe/send` - å‘é€è®¢é˜…æ¶ˆæ¯
  - è¯·æ±‚å‚æ•°ï¼š
    ```json
    {
      "openId": "ç”¨æˆ·openId",
      "templateId": "æ¨¡æ¿ID",
      "page": "è·³è½¬é¡µé¢è·¯å¾„",
      "data": {
        "thing1": { "value": "å›¾ä¹¦åç§°" },
        "date2": { "value": "2024-01-01" },
        // ... å…¶ä»–å­—æ®µ
      }
    }
    ```
  - å“åº”ï¼š`{ success: boolean, message?: string }`

**åç«¯å®ç°å‚è€ƒ**ï¼ˆNode.jsç¤ºä¾‹ï¼‰ï¼š
```javascript
// éœ€è¦å®‰è£…ï¼šnpm install axios
const axios = require('axios');

// è·å–access_token
async function getAccessToken() {
  const appid = 'YOUR_APPID';
  const secret = 'YOUR_SECRET';
  const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appid}&secret=${secret}`;
  const response = await axios.get(url);
  return response.data.access_token;
}

// å‘é€è®¢é˜…æ¶ˆæ¯
async function sendSubscribeMessage(openId, templateId, page, data) {
  const accessToken = await getAccessToken();
  const url = `https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=${accessToken}`;
  
  const response = await axios.post(url, {
    touser: openId,
    template_id: templateId,
    page: page || '',
    data: data,
  });
  
  return response.data;
}
```

### 3. å¼€å‘æµ‹è¯•æ¨¡å¼

**å½“å‰çŠ¶æ€**ï¼šä»£ç ä¸­åŒ…å«äº†å¼€å‘æµ‹è¯•çš„æ¨¡æ‹Ÿæ•°æ®ï¼Œå¯ä»¥åœ¨æ²¡æœ‰åç«¯APIçš„æƒ…å†µä¸‹æµ‹è¯•å‰ç«¯åŠŸèƒ½ï¼š

- âœ… `borrowService.ts` - å›¾ä¹¦åˆ—è¡¨å’Œå€Ÿé˜…æ“ä½œæœ‰æ¨¡æ‹Ÿæ•°æ®
- âœ… `userService.ts` - openIdè·å–å¤±è´¥æ—¶ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆéœ€è¦åç«¯APIæ‰èƒ½æ­£å¸¸å·¥ä½œï¼‰
- âœ… å€Ÿé˜…è®°å½•ä¿å­˜åœ¨æœ¬åœ°å­˜å‚¨ä¸­

**æ³¨æ„äº‹é¡¹**ï¼š
- æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ï¼Œè®¢é˜…æ¶ˆæ¯å‘é€ä¼šå¤±è´¥ï¼ˆéœ€è¦åç«¯APIï¼‰
- å¤šè®¾å¤‡é—´æ•°æ®ä¸åŒæ­¥ï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
- å»ºè®®å°½å¿«é…ç½®åç«¯APIä»¥å®Œæ•´ä½¿ç”¨åŠŸèƒ½

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

åœ¨æ­£å¼ä½¿ç”¨å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·è®¢é˜…æ¶ˆæ¯æ¨¡æ¿
- [ ] å·²å°†æ¨¡æ¿IDé…ç½®åˆ° `subscribeMessage.ts`
- [ ] å·²æ­å»ºåç«¯æœåŠ¡
- [ ] å·²å®ç°æ‰€æœ‰å¿…éœ€çš„åç«¯APIæ¥å£
- [ ] å·²å°†åç«¯APIåœ°å€é…ç½®åˆ°å„ä¸ªæœåŠ¡æ–‡ä»¶ä¸­
- [ ] å·²æµ‹è¯•ç”¨æˆ·ç™»å½•å’ŒopenIdè·å–
- [ ] å·²æµ‹è¯•å€Ÿé˜…å’Œå½’è¿˜æµç¨‹
- [ ] å·²æµ‹è¯•è®¢é˜…æ¶ˆæ¯å‘é€

## ğŸš€ ä½¿ç”¨æµç¨‹

1. **ç”¨æˆ·æˆæƒè®¢é˜…**ï¼ˆå¯é€‰ä½†æ¨èï¼‰
   - è¿›å…¥"è®¢é˜…ç®¡ç†"é¡µé¢
   - æˆæƒéœ€è¦çš„è®¢é˜…æ¶ˆæ¯ç±»å‹

2. **æµè§ˆå›¾ä¹¦**
   - è¿›å…¥"å›¾ä¹¦åˆ—è¡¨"é¡µé¢
   - å¯ä»¥æœç´¢å›¾ä¹¦
   - ç‚¹å‡»å›¾ä¹¦æŸ¥çœ‹è¯¦æƒ…

3. **å€Ÿé˜…å›¾ä¹¦**
   - åœ¨å›¾ä¹¦è¯¦æƒ…é¡µé€‰æ‹©å€Ÿé˜…å¤©æ•°
   - ç‚¹å‡»"ç«‹å³å€Ÿé˜…"
   - ç³»ç»Ÿä¼šè¯·æ±‚è®¢é˜…æˆæƒï¼ˆå¦‚æœæœªæˆæƒï¼‰
   - å€Ÿé˜…æˆåŠŸåå‘é€è®¢é˜…æ¶ˆæ¯

4. **æŸ¥çœ‹å€Ÿé˜…è®°å½•**
   - è¿›å…¥"æˆ‘çš„å€Ÿé˜…"é¡µé¢
   - æŸ¥çœ‹æ‰€æœ‰å€Ÿé˜…è®°å½•
   - æŸ¥çœ‹å‰©ä½™/é€¾æœŸå¤©æ•°

5. **å½’è¿˜å›¾ä¹¦**
   - åœ¨"æˆ‘çš„å€Ÿé˜…"é¡µé¢ç‚¹å‡»"å½’è¿˜"
   - ç¡®è®¤å½’è¿˜åå‘é€å½’è¿˜æˆåŠŸé€šçŸ¥

6. **è‡ªåŠ¨æé†’**
   - ç³»ç»Ÿä¼šåœ¨å½’è¿˜æ—¥æœŸå‰1å¤©ã€3å¤©ã€7å¤©å‘é€æé†’
   - é€¾æœŸåä¼šå‘é€é€¾æœŸæé†’

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è®¢é˜…æ¶ˆæ¯é™åˆ¶**ï¼š
   - æ¯æ¬¡æˆæƒåªèƒ½å‘é€ä¸€æ¬¡æ¶ˆæ¯
   - éœ€è¦ç”¨æˆ·ä¸»åŠ¨æˆæƒ
   - æˆæƒæœ‰æ—¶æ•ˆæ€§

2. **å®šæ—¶æé†’**ï¼š
   - å°ç¨‹åºæ— æ³•é•¿æœŸåå°è¿è¡Œ
   - å»ºè®®ä½¿ç”¨äº‘å‡½æ•°å®šæ—¶è§¦å‘å™¨å®ç°ç²¾ç¡®çš„å®šæ—¶æé†’

3. **æ•°æ®åŒæ­¥**ï¼š
   - å½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå¤šè®¾å¤‡é—´ä¸åŒæ­¥
   - å»ºè®®ä½¿ç”¨åç«¯æ•°æ®åº“å­˜å‚¨å€Ÿé˜…è®°å½•

4. **é”™è¯¯å¤„ç†**ï¼š
   - æ‰€æœ‰APIè°ƒç”¨éƒ½æœ‰é”™è¯¯å¤„ç†
   - å¤±è´¥æ—¶ä¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯
   - å¼€å‘æ¨¡å¼ä¸‹ä¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ— æ³•è·å–openId
- æ£€æŸ¥åç«¯APIæ˜¯å¦æ­£å¸¸
- æ£€æŸ¥å°ç¨‹åºappidå’Œsecretæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥

### é—®é¢˜ï¼šè®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥
- æ£€æŸ¥æ¨¡æ¿IDæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æˆæƒ
- æ£€æŸ¥åç«¯APIæ˜¯å¦æ­£å¸¸è°ƒç”¨å¾®ä¿¡API
- æ£€æŸ¥access_tokenæ˜¯å¦æœ‰æ•ˆ

### é—®é¢˜ï¼šå€Ÿé˜…è®°å½•ä¸æ˜¾ç¤º
- æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥åç«¯APIè¿”å›çš„æ•°æ®æ ¼å¼
- æ£€æŸ¥openIdæ˜¯å¦åŒ¹é…











