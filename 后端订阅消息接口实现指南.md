# åç«¯è®¢é˜…æ¶ˆæ¯æ¥å£å®ç°æŒ‡å—

## âœ… å‰ç«¯å·²é…ç½®

å‰ç«¯ä»£ç å·²é…ç½®å¥½åç«¯APIåœ°å€ï¼š
- **APIåœ°å€**ï¼š`https://ranguofang.com/api`
- **æ¥å£è·¯å¾„**ï¼š`POST /api/subscribe/send`

## ğŸ“‹ éœ€è¦å®ç°çš„åç«¯æ¥å£

### æ¥å£è·¯å¾„
```
POST /api/subscribe/send
```

### è¯·æ±‚å‚æ•°
```json
{
  "openId": "ç”¨æˆ·çš„openId",
  "templateId": "è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ID",
  "page": "ç‚¹å‡»æ¶ˆæ¯åè·³è½¬çš„é¡µé¢è·¯å¾„ï¼ˆå¯é€‰ï¼‰",
  "data": {
    "thing1": { "value": "å›¾ä¹¦åç§°" },
    "date2": { "value": "2024-01-01" },
    "number3": { "value": "7" },
    "character_string4": { "value": "BR123456" }
  }
}
```

### å“åº”æ ¼å¼
```json
{
  "success": true,
  "message": "å‘é€æˆåŠŸ"
}
```

æˆ–å¤±è´¥æ—¶ï¼š
```json
{
  "success": false,
  "message": "é”™è¯¯ä¿¡æ¯"
}
```

## ğŸ”§ Express.js å®ç°ç¤ºä¾‹

### 1. å®‰è£…ä¾èµ–

**âš ï¸ é‡è¦ï¼šä¾èµ–éœ€è¦å®‰è£…åœ¨åç«¯Expressé¡¹ç›®ä¸­ï¼Œä¸æ˜¯å°ç¨‹åºé¡¹ç›®ä¸­ï¼**

#### æ–¹å¼1ï¼šå¦‚æœåç«¯é¡¹ç›®åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ

1. æ‰“å¼€åç«¯Expressé¡¹ç›®çš„ç›®å½•ï¼ˆä¸æ˜¯å°ç¨‹åºé¡¹ç›®ç›®å½•ï¼‰
2. åœ¨è¯¥ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯/å‘½ä»¤è¡Œ
3. æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼š
```bash
npm install axios
```

å¦‚æœé¡¹ç›®è¿˜æ²¡æœ‰ `package.json`ï¼Œå…ˆåˆå§‹åŒ–ï¼š
```bash
npm init -y
npm install axios express
```

#### æ–¹å¼2ï¼šå¦‚æœä½¿ç”¨äº‘å¼€å‘/äº‘æœåŠ¡å™¨éƒ¨ç½²

**è…¾è®¯äº‘å¼€å‘/CloudBaseéƒ¨ç½²**ï¼š
1. ç™»å½• [è…¾è®¯äº‘å¼€å‘æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. è¿›å…¥ä½ çš„äº‘ç¯å¢ƒ
3. æ‰¾åˆ°ä½ çš„ExpressæœåŠ¡ï¼ˆexpress-bec5ï¼‰
4. å¦‚æœæ˜¯é€šè¿‡ä»£ç éƒ¨ç½²ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `package.json` ä¸­æ·»åŠ ä¾èµ–ï¼š
```json
{
  "dependencies": {
    "express": "^4.18.0",
    "axios": "^1.6.0"
  }
}
```
5. é‡æ–°éƒ¨ç½²æœåŠ¡ï¼Œäº‘å¹³å°ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–

**SSHè¿æ¥åˆ°æœåŠ¡å™¨**ï¼š
1. SSHè¿æ¥åˆ°éƒ¨ç½²ExpressæœåŠ¡çš„æœåŠ¡å™¨
2. è¿›å…¥é¡¹ç›®ç›®å½•
3. æ‰§è¡Œï¼š
```bash
cd /path/to/your/express/project
npm install axios
```

**ä½¿ç”¨Docker/å®¹å™¨éƒ¨ç½²**ï¼š
åœ¨ `Dockerfile` æˆ–éƒ¨ç½²é…ç½®ä¸­æ·»åŠ ï¼š
```dockerfile
RUN npm install axios
```

#### æ–¹å¼3ï¼šä½¿ç”¨ä»£ç ä»“åº“éƒ¨ç½²

å¦‚æœä½ ä½¿ç”¨Gitç­‰ä»£ç ä»“åº“éƒ¨ç½²ï¼š
1. åœ¨åç«¯é¡¹ç›®çš„ `package.json` ä¸­æ·»åŠ ä¾èµ–ï¼š
```json
{
  "dependencies": {
    "express": "^4.18.0",
    "axios": "^1.6.0"
  }
}
```
2. æäº¤ä»£ç åˆ°ä»“åº“
3. è§¦å‘è‡ªåŠ¨éƒ¨ç½²ï¼Œéƒ¨ç½²å¹³å°ä¼šè‡ªåŠ¨æ‰§è¡Œ `npm install`

### 2. å®ç°æ¥å£

åœ¨ä½ çš„ Express åº”ç”¨ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```javascript
const express = require('express');
const axios = require('axios');
const router = express.Router();

// å°ç¨‹åºé…ç½®ï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™…å€¼ï¼‰
const APPID = 'YOUR_APPID'; // å°ç¨‹åºAppID
const SECRET = 'YOUR_SECRET'; // å°ç¨‹åºSecret

// ç¼“å­˜access_tokenï¼ˆ2å°æ—¶æœ‰æ•ˆæœŸï¼‰
let accessTokenCache = {
  token: '',
  expireTime: 0
};

/**
 * è·å–access_token
 */
async function getAccessToken() {
  // å¦‚æœç¼“å­˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
  if (accessTokenCache.token && Date.now() < accessTokenCache.expireTime) {
    return accessTokenCache.token;
  }

  try {
    const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${APPID}&secret=${SECRET}`;
    const response = await axios.get(url);
    
    if (response.data.access_token) {
      // ç¼“å­˜tokenï¼Œæå‰5åˆ†é’Ÿè¿‡æœŸ
      accessTokenCache.token = response.data.access_token;
      accessTokenCache.expireTime = Date.now() + (response.data.expires_in - 300) * 1000;
      return response.data.access_token;
    } else {
      throw new Error(response.data.errmsg || 'è·å–access_tokenå¤±è´¥');
    }
  } catch (error) {
    console.error('è·å–access_tokenå¤±è´¥:', error);
    throw error;
  }
}

/**
 * å‘é€è®¢é˜…æ¶ˆæ¯
 */
async function sendSubscribeMessage(openId, templateId, page, data) {
  const accessToken = await getAccessToken();
  const url = `https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=${accessToken}`;
  
  try {
    const response = await axios.post(url, {
      touser: openId,
      template_id: templateId,
      page: page || '',
      data: data,
    });

    if (response.data.errcode === 0) {
      return { success: true, message: 'å‘é€æˆåŠŸ' };
    } else {
      console.error('å‘é€è®¢é˜…æ¶ˆæ¯å¤±è´¥:', response.data);
      return {
        success: false,
        message: response.data.errmsg || 'å‘é€å¤±è´¥'
      };
    }
  } catch (error) {
    console.error('è°ƒç”¨å¾®ä¿¡APIå¤±è´¥:', error);
    return {
      success: false,
      message: error.message || 'å‘é€å¤±è´¥'
    };
  }
}

/**
 * è®¢é˜…æ¶ˆæ¯å‘é€æ¥å£
 */
router.post('/subscribe/send', async (req, res) => {
  try {
    const { openId, templateId, page, data } = req.body;

    // å‚æ•°éªŒè¯
    if (!openId || !templateId || !data) {
      return res.json({
        success: false,
        message: 'å‚æ•°ä¸å®Œæ•´ï¼šç¼ºå°‘openIdã€templateIdæˆ–data'
      });
    }

    // å‘é€è®¢é˜…æ¶ˆæ¯
    const result = await sendSubscribeMessage(openId, templateId, page, data);
    
    res.json(result);
  } catch (error) {
    console.error('å¤„ç†è®¢é˜…æ¶ˆæ¯è¯·æ±‚å¤±è´¥:', error);
    res.json({
      success: false,
      message: error.message || 'æœåŠ¡å™¨é”™è¯¯'
    });
  }
});

module.exports = router;
```

### 3. åœ¨app.jsä¸­æ³¨å†Œè·¯ç”±

```javascript
const subscribeRouter = require('./routes/subscribe'); // æ ¹æ®ä½ çš„æ–‡ä»¶ç»“æ„è°ƒæ•´è·¯å¾„
app.use('/api', subscribeRouter);
```

## âš™ï¸ é…ç½®è¯´æ˜

### 1. é…ç½®å°ç¨‹åºAppIDå’ŒSecret

åœ¨ä»£ç ä¸­æ›¿æ¢ä»¥ä¸‹å€¼ï¼š
- `YOUR_APPID`ï¼šæ›¿æ¢ä¸ºä½ çš„å°ç¨‹åºAppID
- `YOUR_SECRET`ï¼šæ›¿æ¢ä¸ºä½ çš„å°ç¨‹åºSecret

**è·å–æ–¹å¼**ï¼š
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥ **å¼€å‘ -> å¼€å‘ç®¡ç† -> å¼€å‘è®¾ç½®**
3. æŸ¥çœ‹ **AppID(å°ç¨‹åºID)** å’Œ **AppSecret(å°ç¨‹åºå¯†é’¥)**

### 2. å®‰å…¨å»ºè®®

- **ä¸è¦å°†Secretæäº¤åˆ°ä»£ç ä»“åº“**
- å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼š
  ```javascript
  const APPID = process.env.WX_APPID || 'YOUR_APPID';
  const SECRET = process.env.WX_SECRET || 'YOUR_SECRET';
  ```

## ğŸ§ª æµ‹è¯•æ¥å£

### ä½¿ç”¨curlæµ‹è¯•

```bash
curl -X POST https://ranguofang.com/api/subscribe/send \
  -H "Content-Type: application/json" \
  -d '{
    "openId": "ç”¨æˆ·çš„openId",
    "templateId": "æ¨¡æ¿ID",
    "page": "pages/index/index",
    "data": {
      "thing1": { "value": "æµ‹è¯•å›¾ä¹¦" },
      "date2": { "value": "2024-01-01" }
    }
  }'
```

### é¢„æœŸå“åº”

æˆåŠŸï¼š
```json
{
  "success": true,
  "message": "å‘é€æˆåŠŸ"
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **access_tokenæœ‰æ•ˆæœŸ**ï¼šaccess_tokenæœ‰æ•ˆæœŸä¸º2å°æ—¶ï¼Œä»£ç ä¸­å·²å®ç°ç¼“å­˜æœºåˆ¶
2. **é”™è¯¯å¤„ç†**ï¼šéœ€è¦å¤„ç†å„ç§é”™è¯¯æƒ…å†µï¼Œå¦‚ï¼š
   - access_tokenè·å–å¤±è´¥
   - æ¨¡æ¿IDä¸å­˜åœ¨
   - ç”¨æˆ·æœªæˆæƒè®¢é˜…æ¶ˆæ¯
   - ç½‘ç»œè¯·æ±‚å¤±è´¥
3. **è¯·æ±‚é¢‘ç‡é™åˆ¶**ï¼šæ³¨æ„å¾®ä¿¡APIçš„è°ƒç”¨é¢‘ç‡é™åˆ¶
4. **è®¢é˜…æ¶ˆæ¯é™åˆ¶**ï¼šæ¯æ¬¡ç”¨æˆ·æˆæƒåï¼Œè¯¥æ¨¡æ¿åªèƒ½å‘é€ä¸€æ¬¡æ¶ˆæ¯

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… åç«¯æ¥å£å·²é…ç½®å®Œæˆ
2. âš ï¸ éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ï¼Œè·å–æ¨¡æ¿ID
3. âš ï¸ å°†æ¨¡æ¿IDé…ç½®åˆ°å‰ç«¯ä»£ç ä¸­ï¼ˆ`miniprogram/utils/subscribeMessage.ts`ï¼‰

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œè®¢é˜…æ¶ˆæ¯åŠŸèƒ½å³å¯æ­£å¸¸ä½¿ç”¨ï¼

