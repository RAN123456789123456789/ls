# 微信小程序域名配置完整指南

## 🎯 重要理解

### ⚠️ 重要警告

**根据微信公众平台的提示：**
> **云托管域名仅用作测试使用，不可用在正式环境下，请修改。**

这意味着：
- ✅ **测试环境**：可以使用云托管默认域名进行开发和测试
- ❌ **正式环境**：必须使用自定义域名，不能使用云托管默认域名

### 微信小程序域名配置的两个层面

**1. 微信云托管提供的默认域名（仅用于测试）**
- ⚠️ **仅用于测试**：`express-bec5-197615-5-1385276628.sh.run.tcloudbase.com`
- ⚠️ **不能用于正式环境**：微信明确要求必须修改
- ✅ 这个域名可以直接使用，不需要额外配置DNS
- ✅ SSL证书已自动配置
- ✅ 适合开发和测试阶段使用

**2. 微信公众平台的服务器域名配置（必须手动配置）**
- ⚠️ **这是你必须做的**：在微信公众平台添加域名到"服务器域名"
- ⚠️ 小程序代码中使用的所有API域名，都必须在这里配置
- ⚠️ 如果不配置，小程序无法访问你的API
- ⚠️ **正式环境必须使用自定义域名**

## 📋 配置步骤

### 方案一：使用云托管默认域名（仅用于测试）

#### ⚠️ 重要说明
- ✅ **仅用于开发和测试**
- ❌ **不能用于正式环境**
- ⚠️ 微信明确要求正式环境必须使用自定义域名

#### 优点
- ✅ 无需配置DNS
- ✅ 无需域名备案
- ✅ 立即可用
- ✅ SSL证书已自动配置

#### 配置步骤（测试环境）

**第一步：在微信公众平台配置服务器域名**

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com/
   - 使用小程序管理员账号登录

2. **进入开发设置**
   - 左侧菜单：**开发** → **开发管理** → **开发设置**
   - 或直接访问：https://mp.weixin.qq.com/advanced/advanced?action=dev&t=advanced/dev&token=你的token

3. **配置服务器域名**
   - 找到 **服务器域名** 部分
   - 点击 **修改** 按钮
   - 在 **request合法域名** 中添加：
     ```
     https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com
     ```
   - **注意**：只填写域名部分，不要包含 `/api` 路径
   - ⚠️ **注意**：系统会提示"云托管域名仅用作测试使用"，这是正常的
   - 点击 **保存**

4. **等待生效**
   - 配置后立即生效（通常几秒钟）
   - 可以在小程序中测试API调用

#### 当前代码配置

你的代码中已经使用了这个默认域名：

```12:12:miniprogram/utils/borrowRequestService.ts
const API_BASE_URL = 'https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com/api';
```

```11:11:miniprogram/utils/borrowService.ts
const API_BASE_URL = 'https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com/api';
```

```75:75:miniprogram/utils/subscribeService.ts
const API_BASE_URL = 'https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com/api';
```

```39:39:miniprogram/utils/userService.ts
const API_BASE_URL = 'https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com/api';
```

**⚠️ 重要：这只是测试配置，正式环境必须使用自定义域名！**

---

### 方案二：使用自定义域名（正式环境必须）

#### ⚠️ 正式环境要求
- ✅ **正式环境必须使用自定义域名**
- ✅ 推荐使用子域名：`api.ranguofang.com`
- ✅ 更专业、更稳定

如果你想使用自己的域名（如 `ranguofang.com` 或 `api.ranguofang.com`），需要额外配置：

#### 配置步骤

**第一步：在微信云托管添加自定义域名**

1. 登录腾讯云控制台
2. 进入微信云托管 → 域名管理
3. 添加域名：`ranguofang.com` 或 `api.ranguofang.com`（推荐子域名）
4. 获取CNAME记录值

**第二步：配置DNS解析**

1. 登录域名服务商控制台
2. 添加CNAME记录：
   - 主机记录：`@`（主域名）或 `api`（子域名）
   - 记录类型：`CNAME`
   - 记录值：云托管提供的CNAME值
3. 等待DNS生效（5-30分钟）

**第三步：在微信公众平台配置域名**

1. 登录微信公众平台
2. 进入 **开发** → **开发管理** → **开发设置**
3. 在 **request合法域名** 中添加：
   - `https://ranguofang.com` 或
   - `https://api.ranguofang.com`（推荐）

**第四步：更新代码中的API地址**

需要更新以下文件中的 `API_BASE_URL`：
- `miniprogram/utils/borrowRequestService.ts`
- `miniprogram/utils/borrowService.ts`
- `miniprogram/utils/subscribeService.ts`
- `miniprogram/utils/userService.ts`

**第五步：域名备案（如果使用主域名）**

- 如果使用主域名 `ranguofang.com`，可能需要ICP备案
- 如果使用子域名 `api.ranguofang.com`，通常不需要备案（如果主域名已备案）

**第六步：更新代码中的API地址**

配置完成后，需要更新以下文件中的 `API_BASE_URL`：
- `miniprogram/utils/borrowRequestService.ts`
- `miniprogram/utils/borrowService.ts`
- `miniprogram/utils/subscribeService.ts`
- `miniprogram/utils/userService.ts`

将 `API_BASE_URL` 从：
```typescript
const API_BASE_URL = 'https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com/api';
```

改为：
```typescript
const API_BASE_URL = 'https://api.ranguofang.com/api'; // 或 https://ranguofang.com/api
```

---

## ✅ 快速开始

### 阶段一：测试环境（立即可用）

**如果你想立即测试小程序：**

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** → **开发管理** → **开发设置**
3. 在 **request合法域名** 中添加：
   ```
   https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com
   ```
4. 点击 **保存**（系统会提示这是测试域名，这是正常的）

**完成！** 你的小程序现在可以正常调用API进行测试了。

⚠️ **注意**：这只是测试配置，正式发布前必须配置自定义域名。

### 阶段二：正式环境（必须配置）

**正式发布前必须完成：**

1. ✅ 在微信云托管添加自定义域名（如 `api.ranguofang.com`）
2. ✅ 配置DNS解析（CNAME记录）
3. ✅ 在微信公众平台添加自定义域名到request合法域名
4. ✅ 更新代码中的API地址
5. ✅ 域名备案（如果使用主域名）

---

## 🔍 验证配置是否成功

### 方法1：在微信公众平台检查

1. 登录微信公众平台
2. 进入 **开发** → **开发管理** → **开发设置**
3. 查看 **服务器域名** → **request合法域名**
4. 确认你的域名已添加

### 方法2：在小程序中测试

1. 在微信开发者工具中运行小程序
2. 尝试调用API（如登录、获取图书列表等）
3. 查看控制台是否有错误
4. 如果API调用成功，说明配置正确

### 方法3：查看网络请求

1. 在微信开发者工具中
2. 打开 **调试器** → **Network**（网络）
3. 查看API请求是否成功
4. 如果返回200状态码，说明配置正确

---

## ⚠️ 常见问题

### Q1: 为什么小程序无法访问API？

**可能原因：**
- ❌ 未在微信公众平台配置服务器域名
- ❌ 域名配置错误（包含了路径 `/api`）
- ❌ 使用了HTTP而不是HTTPS

**解决方法：**
- ✅ 在微信公众平台添加域名（只填写域名，不包含路径）
- ✅ 确保使用 `https://` 协议

### Q2: 云托管默认域名需要备案吗？

**答案：不需要备案，但只能用于测试！**
- 云托管的默认域名（`*.sh.run.tcloudbase.com`）已经备案
- 可以直接使用，无需额外备案
- ⚠️ **但微信明确要求正式环境必须使用自定义域名**

### Q3: 自定义域名需要备案吗？

**答案：取决于域名类型**
- **主域名**（如 `ranguofang.com`）：通常需要备案
- **子域名**（如 `api.ranguofang.com`）：如果主域名已备案，通常不需要单独备案

### Q4: 可以同时使用多个域名吗？

**答案：可以**
- 在微信公众平台可以配置多个request合法域名
- 但代码中只能使用一个 `API_BASE_URL`
- 如果需要切换域名，需要修改代码

### Q5: 配置后多久生效？

**答案：**
- **微信公众平台配置**：立即生效（几秒钟）
- **DNS配置**：5-30分钟
- **域名备案**：3-20个工作日

---

## 📝 总结

### 你现在需要做的：

#### 阶段一：测试环境（现在就可以做）

1. ✅ **立即配置测试域名**：在微信公众平台添加云托管默认域名
   - 域名：`https://express-bec5-197615-5-1385276628.sh.run.tcloudbase.com`
   - 位置：开发 → 开发管理 → 开发设置 → 服务器域名 → request合法域名
   - ⚠️ 注意：系统会提示这是测试域名，这是正常的

#### 阶段二：正式环境（正式发布前必须完成）

2. ✅ **必须配置自定义域名**：按照方案二配置
   - 推荐使用：`api.ranguofang.com`
   - 需要：云托管域名绑定 + DNS配置 + 微信公众平台配置 + 代码更新
   - 可能需要：域名备案（如果使用主域名）

### 配置优先级：

- 🟢 **测试阶段**：可以使用云托管默认域名
- 🔴 **正式发布**：必须使用自定义域名

---

## 🎯 下一步

配置完成后，告诉我，我可以帮你：
1. 测试API连接是否正常
2. 如果使用自定义域名，更新代码中的API地址
3. 排查任何配置问题

