# 数据库索引配置说明

## 问题描述

在使用云开发数据库查询用户信息时，如果启用了权限控制，云开发会自动添加 `_openid` 字段作为查询条件（确保用户只能查询自己的数据）。这导致实际执行的查询同时包含了 `openId`（自定义字段）和 `_openid`（云开发自动字段）两个字段。

当数据库中没有相应的索引时，查询效率会很低，云开发控制台会提示创建索引。

## 解决方案

### 方案一：创建组合索引（推荐）

在云开发控制台中为 `user` 集合创建组合索引：

**索引字段：**
- `openId`: 升序
- `_openid`: 升序

**创建步骤：**
1. 打开微信开发者工具
2. 进入"云开发" -> "数据库"
3. 选择 `user` 集合
4. 点击"索引管理"
5. 点击"添加索引"
6. 添加以下字段：
   - 字段名：`openId`，排序：升序
   - 字段名：`_openid`，排序：升序
7. 点击"创建"

**快速创建链接：**
如果云开发控制台提供了快速创建链接，可以直接点击链接创建索引。

### 方案二：优化查询逻辑

如果不需要权限控制，可以在云开发控制台中修改集合的权限设置：
1. 进入"云开发" -> "数据库"
2. 选择 `user` 集合
3. 点击"权限设置"
4. 将权限设置为"仅创建者可读写"或"所有用户可读，仅创建者可写"

**注意：** 修改权限设置可能会影响数据安全性，请谨慎操作。

## 索引创建后的效果

创建索引后：
- 查询速度会显著提升
- 云开发控制台不再提示索引建议
- 数据库查询性能优化

## 相关代码位置

查询用户信息的代码位于：
- `miniprogram/utils/userService.ts` - `getUserFromDatabase()` 函数（第425-427行）
- `miniprogram/utils/userService.ts` - `saveUserToDatabase()` 函数（第180-182行）
- `miniprogram/utils/userService.ts` - `updateUserProfile()` 函数（第769-771行）

## 注意事项

1. 索引创建后需要等待一段时间才能生效（通常几秒钟到几分钟）
2. 索引会占用一定的存储空间，但对于提升查询性能是值得的
3. 如果数据量很大，创建索引可能需要较长时间

