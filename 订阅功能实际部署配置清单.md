# 订阅功能实际部署配置清单

## 📋 必需配置项（3项）

### ✅ 1. 订阅消息模板ID配置（前端） ✅ **已完成**

**文件位置**：`miniprogram/utils/subscribeMessage.ts`

**当前状态**：
- ✅ **借阅成功通知**：`Ya0w7HLKqR8sffQ8YsR5eWf8-5vTO7GKFjTTmvek-Dg` - 已配置
- ✅ **归还提醒通知**：`Ya0w7HLKqR8sffQ8YsR5eVKuxoGeRtCp-53iadgUMTg` - 已配置（使用归还成功模板）
- ✅ **逾期提醒通知**：`Ya0w7HLKqR8sffQ8YsR5efyuXdj_R1dubgURiRp2b8c` - 已配置
- ✅ **归还成功通知**：`Ya0w7HLKqR8sffQ8YsR5eVKuxoGeRtCp-53iadgUMTg` - 已配置

**已配置的模板ID**：

```typescript
// 在 subscribeMessage.ts 的第 39-58 行
export const SUBSCRIBE_MESSAGE_TEMPLATES = {
    [SubscribeMessageType.BORROW_SUCCESS]: {
        templateId: 'Ya0w7HLKqR8sffQ8YsR5eWf8-5vTO7GKFjTTmvek-Dg', // ✅ 已配置
        // ...
    },
    [SubscribeMessageType.RETURN_REMINDER]: {
        templateId: 'Ya0w7HLKqR8sffQ8YsR5eVKuxoGeRtCp-53iadgUMTg', // ✅ 已配置（使用归还成功模板）
        // ...
    },
    [SubscribeMessageType.OVERDUE_REMINDER]: {
        templateId: 'Ya0w7HLKqR8sffQ8YsR5efyuXdj_R1dubgURiRp2b8c', // ✅ 已配置
        // ...
    },
    [SubscribeMessageType.RETURN_SUCCESS]: {
        templateId: 'Ya0w7HLKqR8sffQ8YsR5eVKuxoGeRtCp-53iadgUMTg', // ✅ 已配置
        // ...
    },
};
```

**✅ 所有模板ID已配置完成**：

所有4个订阅消息模板ID都已配置完成。归还提醒通知使用了归还成功通知的模板ID。

**⚠️ 重要提示**：
- 模板字段名称必须完全匹配（thing1, date2, number3等）
- 字段类型必须正确（thing=事物, date=日期, number=数字, character_string=字符串）
- 如果字段顺序不同，需要调整 `buildTemplateData` 函数中的字段映射

---

### ✅ 2. 后端接口实现 ⚠️ **必需**

**接口路径**：`POST /api/subscribe/send`

**部署地址**：`https://ranguofang.com/api/subscribe/send`

**需要实现的功能**：
1. 接收前端发送的订阅消息请求
2. 获取微信 access_token（需要小程序AppID和Secret）
3. 调用微信API发送订阅消息

**参考实现**：已创建 `后端订阅消息接口实现指南.md`

**关键配置**：
- 小程序 AppID（从微信公众平台获取）
- 小程序 Secret（从微信公众平台获取）

**获取AppID和Secret**：
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发 -> 开发管理 -> 开发设置**
3. 查看 **AppID(小程序ID)**
4. 查看并重置 **AppSecret(小程序密钥)**（如果忘记了）

---

### ✅ 3. 后端API地址配置（前端） ✅ **已完成**

**文件位置**：`miniprogram/utils/subscribeService.ts`

**当前配置**：
```typescript
const API_BASE_URL = 'https://ranguofang.com/api';
```

**状态**：✅ 已配置，无需修改

---

## 📝 配置步骤总结

### 第一步：模板ID配置 ✅ **已完成**

**✅ 所有4个模板ID已配置完成**：
- 借阅成功通知 ✅
- 归还提醒通知 ✅（使用归还成功模板）
- 逾期提醒通知 ✅
- 归还成功通知 ✅

### 第三步：实现后端接口

1. 获取小程序 AppID 和 Secret
2. 参考 `后端订阅消息接口实现指南.md` 实现接口
3. 在代码中配置 AppID 和 Secret
4. 部署后端服务

### 第四步：测试

1. 在小程序中测试订阅授权
2. 测试发送订阅消息
3. 检查是否收到消息

---

## ✅ 检查清单

在正式使用前，请确认以下所有项都已完成：

- [x] **已在微信公众平台申请订阅消息模板**
- [x] **已获取所有模板的模板ID并配置完成**（4个模板ID已全部配置）
- [ ] **已获取小程序AppID和Secret**
- [ ] **已实现后端 `/api/subscribe/send` 接口**
- [ ] **已在后端配置AppID和Secret**
- [ ] **已测试后端接口是否正常工作**
- [ ] **已在小程序中测试订阅授权功能**
- [ ] **已测试发送订阅消息并确认收到**

---

## 🚨 常见问题

### Q1: 模板申请被拒绝怎么办？
**A**: 
- 检查模板内容是否符合规范
- 确保字段类型正确
- 可以尝试使用微信提供的公共模板库中的模板

### Q2: 发送订阅消息失败？
**A**: 
- 检查模板ID是否正确
- 检查用户是否已授权该模板
- 检查后端access_token是否有效
- 查看后端日志确认错误原因

### Q3: 订阅消息授权后收不到消息？
**A**: 
- 确认后端接口已正确实现
- 确认后端能成功调用微信API
- 检查订阅消息的发送时机（一次授权只能发送一次）
- 确认消息内容格式正确

### Q4: 模板字段不匹配？
**A**: 
- 检查模板中申请的字段名称（thing1, date2等）
- 检查字段类型是否匹配
- 可能需要调整 `buildTemplateData` 函数中的字段映射

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. 微信公众平台中的模板配置
2. 后端接口日志
3. 小程序开发者工具的控制台日志

配置完成后，订阅功能即可正常使用！

