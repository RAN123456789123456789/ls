# 连接超时问题排查指南

## 🔍 错误信息

```
POST https://ranguofang.com/api/user/getOpenId net::ERR_CONNECTION_TIMED_OUT
```

## ⚠️ 可能的原因

### 1. 域名未在微信公众平台配置（最可能）

**微信小程序安全限制**：小程序只能访问在微信公众平台配置的合法域名。

### 2. 后端服务未运行

- 云托管服务可能没有启动
- 服务可能已停止

### 3. DNS解析问题

- 域名解析可能有问题
- 域名可能未正确绑定到云托管

### 4. 网络问题

- 本地网络问题
- 防火墙阻止连接

## ✅ 解决步骤

### 步骤1：在微信公众平台配置域名（必须！）

**这是最重要的步骤！**

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com/
   - 使用管理员账号登录

2. **进入开发设置**
   - 左侧菜单：**开发** → **开发管理** → **开发设置**

3. **配置服务器域名**
   - 找到 **服务器域名** 部分
   - 点击 **修改** 按钮
   - 在 **request合法域名** 中添加：
     ```
     https://ranguofang.com
     ```
   - **注意**：不要加 `/api`，只写域名部分
   - 点击 **保存**

4. **等待生效**
   - 配置后可能需要几分钟生效
   - 重新编译小程序

### 步骤2：检查后端服务状态

1. **登录腾讯云控制台**
   - 访问：https://console.cloud.tencent.com/
   - 进入 **微信云托管**

2. **检查服务状态**
   - 找到 express-bec5 服务
   - 确认状态为 **"运行中"**
   - 确认实例数量 ≥ 1

3. **查看运行日志**
   - 进入服务详情 → **运行日志**
   - 确认服务正常启动
   - 查看是否有错误信息

### 步骤3：测试后端API

**在浏览器中测试**（不使用小程序）：

1. **测试健康检查接口**
   ```
   https://ranguofang.com/api/health
   ```
   - 应该返回：`{ "status": "ok", "message": "服务运行正常" }`

2. **如果无法访问**
   - 检查DNS解析：`nslookup ranguofang.com`
   - 检查SSL证书是否有效
   - 检查域名是否正确绑定到云托管

### 步骤4：检查小程序配置

1. **确认API地址正确**
   - 检查 `miniprogram/utils/userService.ts`
   - 确认 `API_BASE_URL = 'https://ranguofang.com/api'`

2. **重新编译小程序**
   - 在微信开发者工具中点击 **"编译"**
   - 清除缓存后重新编译

## 📋 检查清单

- [ ] **已在微信公众平台配置域名**（最重要！）
  - [ ] 域名：`https://ranguofang.com`
  - [ ] 添加到 request合法域名
  - [ ] 已保存配置

- [ ] **后端服务正在运行**
  - [ ] 云托管服务状态：运行中
  - [ ] 实例数量 ≥ 1
  - [ ] 运行日志正常

- [ ] **后端API可以访问**
  - [ ] 可以访问 `https://ranguofang.com/api/health`
  - [ ] DNS解析正常
  - [ ] SSL证书有效

- [ ] **小程序已重新编译**
  - [ ] 清除缓存
  - [ ] 重新编译

## 🔧 临时解决方案

当前代码已经实现了降级处理：
- 如果后端API不可用，会自动生成临时openId
- 功能可以继续使用，但某些需要真实openId的功能可能受限

临时openId格式：`temp_时间戳_随机字符串`

## ⚠️ 重要提示

**微信小程序的安全限制**：
- 小程序只能访问配置的合法域名
- 未配置的域名会被阻止访问
- 这是微信的安全机制，无法绕过

**必须配置域名才能正常使用后端API！**

## 🎯 下一步

1. **立即在微信公众平台配置域名**（必须）
2. **等待配置生效**（几分钟）
3. **重新编译小程序**
4. **测试功能**

配置域名后，连接超时问题应该就能解决了。

