# 部署问题修复说明

## 🔍 问题分析

**错误信息**：
```
Liveness probe failed: dial tcp 10.23.21.133:80: connect: connection refused
Readiness probe failed: dial tcp 10.23.21.133:80: connect: connection refused
```

**原因**：
- 服务监听在 8080 端口
- 云托管健康检查使用 80 端口
- 端口不匹配导致健康检查失败

## ✅ 已修复

1. **修改 server.js**：将默认端口从 8080 改为 80
2. **修改 Dockerfile**：将 EXPOSE 从 8080 改为 80

## 📋 云托管配置检查

### 1. 端口配置

在云托管控制台检查：
- **服务设置** → **端口配置**
- 确保容器端口设置为 **80**
- 确保访问端口映射正确

### 2. 健康检查配置

在云托管控制台检查：
- **服务设置** → **健康检查**
- 健康检查路径：`/health`
- 健康检查端口：`80`
- 超时时间：建议设置为 10-30 秒

### 3. 环境变量配置

确保已配置：
- `WX_APPID` = `wxc514634bfc130f84`
- `WX_SECRET` = 你的小程序 Secret

## 🚀 重新部署

1. **代码已更新并推送到 GitHub**
2. **在云托管控制台重新部署**：
   - 点击 **"发布"** 按钮
   - 选择代码仓库部署
   - 等待构建和部署完成

## 📝 健康检查接口

服务提供健康检查接口：
- **路径**：`GET /health`
- **响应**：`{ "status": "ok", "message": "服务运行正常" }`

## ⚠️ 注意事项

1. **端口 80 需要 root 权限**：
   - Node.js 在 Docker 容器中默认以非 root 用户运行
   - 如果遇到权限问题，可能需要修改 Dockerfile

2. **如果端口 80 仍有问题**：
   - 可以尝试使用环境变量 `PORT=80`
   - 或者在云托管配置端口映射（容器80 → 访问8080）

3. **查看日志**：
   - 部署后查看"运行日志"
   - 确认服务是否正常启动
   - 检查是否有错误信息

## 🔧 如果还有问题

### 方案1：使用非特权端口 + 端口映射

如果 80 端口有权限问题，可以：
1. 服务监听 8080
2. 在云托管配置端口映射：容器 8080 → 访问 80

### 方案2：修改 Dockerfile 使用 root 用户

```dockerfile
# 在 Dockerfile 中添加
USER root
```

但这不是推荐做法，因为存在安全风险。

## 📊 当前配置

- **服务端口**：80（从环境变量 PORT 读取，默认 80）
- **健康检查路径**：/health
- **监听地址**：0.0.0.0（所有网络接口）

## ✅ 下一步

1. 确认云托管端口配置为 80
2. 确认健康检查路径为 `/health`
3. 重新部署服务
4. 查看运行日志确认服务正常启动

